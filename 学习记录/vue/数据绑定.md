## å¾ªåºæ¸è¿›çš„æ•°æ®ç»‘å®šï¼ˆæ–°ï¼‰

æœ€è¿‘å…³æ³¨çš„å¾®ä¿¡å…¬ä¼—å·ã€å‰ç«¯æ—©è¯»è¯¾ã€‘ä¸Šçœ‹åˆ°ä¸€ç¯‡å¾ªåºæ¸è¿›ï¼Œç”±æµ…å…¥æ·±çš„è§£é‡Šï¼Œä¸ªäººæ„Ÿè§‰æ›´åŠ ç›´ç™½ï¼Œé€‚åˆæ–°æ‰‹ã€‚å› æ­¤ä»æƒ…å°è€å“¥é‚£è¾¹è¦æ¥äº†åŸæ–‡ï¼Œæ”¶è—èµ·æ¥ã€‚

å…³äºæœ¬æ–‡
è¯‘è€…ï¼š@èŠ±ç”Ÿ
ä½œè€…ï¼š@Gregg Pollack
åŸæ–‡ï¼š
[https://medium.com/vue-mastery/the-best-explanation-of-javascript-reactivity-fea6112dd80d](https://medium.com/vue-mastery/the-best-explanation-of-javascript-reactivity-fea6112dd80d)

ä»Šæ—¥æ—©è¯»æ–‡ç« ç”±æ±½è½¦ä¹‹å®¶@èŠ±ç”Ÿç¿»è¯‘æŠ•ç¨¿åˆ†äº«ã€‚

è¯‘è€…æ³¨ï¼šæœ¬æ–‡æ—¨åœ¨è§£é‡Šå“åº”å¼çš„åŸç†(ä¹Ÿå¯ä»¥è¯´æ•°æ®åŒå‘ç»‘å®šçš„å®ç°)ï¼Œè™½ç„¶è¯é¢˜è¾ƒè€ï¼Œä½†éƒ¨åˆ†è§‚ç‚¹å¾ˆå¥‡ç‰¹ã€‚

>@èŠ±ç”Ÿ,å°±èŒäºæ±½è½¦ä¹‹å®¶ç”¨æˆ·äº§å“ä¸­å¿ƒå›¢é˜Ÿï¼Œäº‘äº‘æ¬ç –ç å†œçš„ä¸­çš„ä¸€å‘˜ã€‚

æ­£æ–‡ä»è¿™å¼€å§‹ï½ï½

### ğŸš€ å¼€å§‹

è®¸å¤šå‰ç«¯çš„JavaScriptæ¡†æ¶ï¼ˆä¾‹å¦‚Angularï¼ŒReactå’ŒVueï¼‰éƒ½æœ‰è‡ªå·±çš„å“åº”å¼å¼•æ“ã€‚äº†è§£å…¶å“åº”åŸç†åŠå·¥ä½œåŸç†ï¼Œæœ‰åŠ©äºæå‡è‡ªå·±å¹¶æ›´åŠ æœ‰æ•ˆåœ°ä½¿ç”¨æ¡†æ¶ã€‚åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­ï¼Œæ¨¡æ‹Ÿäº†Vueæºç ä¸­çš„å“åº”åŸç†ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ã€‚

### ğŸ’¡ å“åº”å¼

å½“ä½ ç¬¬ä¸€æ¬¡çœ‹åˆ°Vueå·¥ä½œæ—¶ï¼Œä½ ä¼šè§‰å¾—å®ƒå¾ˆç¥å¥‡ã€‚ä»¥è¿™ä¸ªç®€å•çš„Vueåº”ç”¨ç¨‹åºä¸ºä¾‹ï¼š

```html
<div id="app">
  <div>Price: ${{ price}}</div>
  <div>Total: ${{ price * quantity }}</div>
  <div>Taxes: ${{ totalPriceWithTax}}</div>
</div>
<script>
  var vm = new Vue({
    el: '#app',
    data: {
      price: 5.00,
      quantity: 2
    },
    computed: {
      totalPriceWithTax() {
        return  this.price * this.quantity * 1.03
      }
    }
  })
</script>
```

å½“priceå‘ç”Ÿå˜åŒ–åï¼ŒVueä¼šåšä¸‰ä»¶äº‹ï¼š

* åœ¨é¡µé¢ä¸Šæ›´æ–°priceçš„å€¼ã€‚
* é‡æ–°è®¡ç®—price * quantityçš„å€¼ï¼Œå¹¶æ›´æ–°é¡µé¢ã€‚
* å†æ¬¡è°ƒç”¨totalPriceWithTaxï¼Œå¹¶æ›´æ–°é¡µé¢ã€‚

ä¸è¿‡è¿™å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯å½“priceå˜åŒ–æ—¶ï¼ŒVueæ€ä¹ˆçŸ¥é“è¯¥æ›´æ–°ä»€ä¹ˆï¼Œä»¥åŠå®ƒæ˜¯å¦‚ä½•è·Ÿè¸ªæ‰€æœ‰å†…å®¹çš„ï¼Ÿ

é€šå¸¸çš„JavaScriptä»£ç æ˜¯å®ç°ä¸äº†è¿™æ ·çš„åŠŸèƒ½çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹è¾¹çš„ä»£ç ï¼š

```js
let price = 5
let quantity = 2
let total = price * quantity // => 10
price = 20
console.log(`total is ${total}`)
```

å®ƒä¼šæ‰“å°10ï¼š

```
>> total is 10
```

åœ¨Vueä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›priceæˆ–quantityå˜åŒ–åtotalè·Ÿç€æ›´æ–°ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯å¦‚ä¸‹çš„ç»“æœï¼š

```
>> total is 40
```

ä¸å·§çš„æ˜¯ï¼ŒJavaScriptä¸æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰å¾—åˆ°æƒ³è¦çš„ç»“æœã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¾—æƒ³ç‚¹åŠæ³•ï¼Œæ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚

### âš ï¸ é—®é¢˜ä¸€
æˆ‘ä»¬éœ€è¦ä¿å­˜è®¡ç®—totalçš„æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨priceæˆ–quantityå‘ç”Ÿå˜åŒ–æ—¶å†ä¸€æ¬¡è°ƒç”¨ã€‚

### âœ… è§£å†³æ–¹æ¡ˆ
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•æ¥å‘Šè¯‰æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œâ€œå­˜å‚¨æˆ‘å°†è¦è°ƒç”¨çš„è¿™æ®µä»£ç ï¼Œæˆ‘å¯èƒ½ä¼šåœ¨å…¶ä»–æ—¶é—´å†æ¬¡è°ƒç”¨ã€‚â€ç´§æ¥ç€æˆ‘ä»¬æ¥æ‰§è¡Œè¿™æ®µä»£ç ï¼Œå½“priceæˆ–quantityå˜é‡æ›´æ–°åï¼Œå†æ¬¡è¿è¡Œä¹‹å‰å­˜å‚¨çš„ä»£ç ã€‚

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè®°å½•å‡½æ•°æ¥ä¿å­˜æˆ‘ä»¬è¦çš„ä¸œè¥¿ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å†æ¬¡è°ƒç”¨å®ƒï¼š

```js
let price = 5
let quantity = 2
let total = 0
let target = null

target = () => { total = price * quantity }

record()
target()
```

æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨targetå˜é‡ä¸­å­˜å‚¨ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç„¶åè°ƒç”¨recordå‡½æ•°ã€‚recordçš„å®šä¹‰å¾ˆç®€å•ï¼š

```js
let storge = [] // ç”¨æ¥å­˜å‚¨target

// è®°å½•å‡½æ•°
function record (){
  storge.push(target)
}
```

æˆ‘ä»¬å·²ç»ä¿å­˜äº†targetï¼ˆ`{total = price * quantity`}ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¹‹åå†è¿è¡Œå®ƒï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªreplayå‡½æ•°ï¼Œæ¥è¿è¡Œæˆ‘ä»¬æ‰€è®°å½•çš„æ‰€æœ‰å†…å®¹ã€‚

```js
function replay (){
  storge.forEach(run => run())
}
```

è¿™å°†éå†å­˜å‚¨åœ¨storageè¿™ä¸ªæ•°ç»„ä¸­çš„æ‰€æœ‰åŒ¿åå‡½æ•°ï¼Œå¹¶æ‰§è¡Œæ¯ä¸ªå‡½æ•°ã€‚

ç„¶åå°±ä¼šå˜æˆè¿™æ ·ï¼š

```js
price = 20
console.log(total) // => 10
replay()
console.log(total) // => 40
```

ä¸‹é¢æ˜¯å®Œæ•´çš„ä»£ç ï¼Œä½ å¯ä»¥é€šè¯»ä»¥æ–¹ä¾¿ç†è§£ï¼š

```js
let price = 5
let quantity = 2
let total = 0
let target = null
let storge = [] // ç”¨æ¥å­˜å‚¨target

// è®°å½•å‡½æ•°
function record (){
  storge.push(target)
}

function replay (){
  storge.forEach(run => run())
}

target = () => { total = price * quantity }

record()
target()

price = 20
console.log(total) // => 10
replay()
console.log(total) // => 40
```

### âš ï¸ é—®é¢˜äºŒ
æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œç»§ç»­è®°å½•targetè¿™ç±»çš„ä»£ç ï¼Œä½†æœ€å¥½æœ‰ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„åŠæ³•ã€‚

### âœ… è§£å†³æ–¹æ¡ˆï¼šä¾èµ–ç±»

æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯å°†è¿™ç§è¡Œä¸ºï¼ˆtargetè¿™ç§åŒ¿åå‡½æ•°ï¼‰å°è£…åˆ°å®ƒè‡ªå·±çš„ç±»ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†ç¼–ç¨‹ä¸­å®ç°è§‚å¯Ÿè€…æ¨¡å¼çš„**ä¾èµ–ç±»**ã€‚

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªJavaScriptç±»æ¥ç®¡ç†æˆ‘ä»¬çš„ä¾èµ–é¡¹ï¼ˆä½¿å®ƒæ›´æ¥è¿‘Vueçš„å¤„ç†æ–¹å¼ï¼‰ï¼Œå°±åƒè¿™æ ·ï¼š

```js
class Dep { // ä¾‹å­
  constructor () {
    this.subscribers = [] //  æ›¿ä»£ä¹‹å‰çš„storage
  }
  depend () {  //  æ›¿ä»£ä¹‹å‰çš„record
    if (target && !this.subscribers.includes(target)) {
      this.subscribers.push(target)
    }
  }
  notify () { // æ›¿ä»£ä¹‹å‰çš„replay
    this.subscribers.forEach(sub => sub())  //  è¿è¡Œæˆ‘ä»¬çš„targetæˆ–è§‚å¯Ÿè€…
  }
}
```

æ³¨æ„ï¼Œæˆ‘ä»¬ç°åœ¨å°†åŒ¿åå‡½æ•°å­˜å‚¨åœ¨subscribersä¸­ï¼Œè€Œä¸æ˜¯storageï¼Œrecordä¹Ÿå˜æˆäº†dependï¼Œä½¿ç”¨notifyæ¥ä»£æ›¿replayï¼Œç„¶åå°±ä¼šå˜æˆè¿™æ ·ï¼š

```js
const dep = new Dep()

let price = 5
let quantity = 2
let total = 0
let target = () => { total = price * quantity }
dep.depend() // targetæ·»åŠ åˆ°subscribersä¸­
target() // è¿è¡Œå¹¶å¾—åˆ°total

console.log(total) // => 10
price = 20
console.log(total) // => 10
dep.notify()  // è°ƒç”¨subscribersé‡Œå­˜å‚¨çš„target
console.log(total) // => 40
```

æ”¹äº†å‘½åï¼Œä¾æ—§å¯ä»¥è¿è¡Œï¼Œä½†æ›´é€‚åˆå¤ç”¨ã€‚å”¯ä¸€æœ‰ç‚¹åˆ«æ‰­çš„å°±æ˜¯targetçš„å­˜å‚¨å’Œè°ƒç”¨ã€‚

### âš ï¸ é—®é¢˜ä¸‰
æˆ‘ä»¬ä¼šä¸ºæ¯ä¸ªå˜é‡åˆ›å»ºä¸€ä¸ªä¾èµ–ç±»ï¼Œå¹¶ä¸”å¯¹åˆ›å»ºåŒ¿åå‡½æ•°çš„è¡Œä¸ºè¿›è¡Œå°è£…ï¼Œä»è€Œåšåˆ°å“åº”å¼ã€‚è€Œä¸æ˜¯åƒè¿™æ ·è°ƒç”¨ï¼ˆè¿™æ˜¯ä¸Šé¢çš„éƒ¨åˆ†ä»£ç ï¼‰ï¼š

```js
target = () => { total = price * quantity }
dep.depend()
target()
```

æˆ‘ä»¬å¯ä»¥æ”¹ä¸ºï¼š

```js
watcher(() => {
  total = price * quantity
})
```

### âœ… è§£å†³æ–¹æ¡ˆ: ç›‘å¬å‡½æ•°ï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰
åœ¨æˆ‘ä»¬çš„ç›‘å¬å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›ç®€å•çš„äº‹æƒ…ï¼š

```js
function watcher(myFun) {
  target = myFun
  dep.depend()
  target()
  target = null
}
```

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œwatcherå‡½æ•°æ¥å—myFuncå‚æ•°ï¼Œå°†å…¶èµ‹ç»™å…¨å±€çš„targetä¸Šï¼Œè°ƒç”¨dep.depend()å°†å…¶æ·»åŠ åˆ°subscribersé‡Œï¼Œä¹‹åè°ƒç”¨å¹¶é‡ç½®targetã€‚

è¿è¡Œä¸‹é¢çš„ä»£ç ï¼š

```js
price = 20
console.log(total)
dep.notify()
console.log(total)
```

è¾“å‡ºï¼š

```
>> 10
>> 40
```

è¿˜æœ‰ä¸ªé—®é¢˜æ²¡æœ‰è¯´ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å°†targetè®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œè€Œä¸æ˜¯åœ¨éœ€è¦çš„æ—¶å€™å°†å…¶ä¼ é€’åˆ°å‡½æ•°ä¸­ã€‚è¿™ä¸ªç­”æ¡ˆï¼Œè¯·åœ¨åè¾¹çš„å†…å®¹é‡Œå¯»æ‰¾ã€‚

### âš ï¸ é—®é¢˜å››
æˆ‘ä»¬æœ‰ä¸€ä¸ªDep classï¼Œä½†æˆ‘ä»¬çœŸæ­£æƒ³è¦çš„æ˜¯æ¯ä¸ªå˜é‡éƒ½æœ‰å®ƒè‡ªå·±çš„ä¾èµ–ç±»ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸ªå±æ€§éƒ½æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œã€‚

```js
let data = { price: 5, quantity: 2 }
```

å‡è®¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æ¯ä¸ªå±æ€§ï¼ˆpriceå’Œquantityï¼‰éƒ½æœ‰è‡ªå·±çš„ä¾èµ–ç±»ã€‚

![1](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/1.jpg)

è¿è¡Œä¸‹é¢çš„ä»£ç ï¼š

```js
watcher(() => {
  total = data.price * data.quantity
})
```

å› ä¸ºdata.priceå€¼è¢«è®¿é—®ï¼Œæˆ‘å¸Œæœ›priceå±æ€§çš„ä¾èµ–ç±»å°†æˆ‘ä»¬å­˜å‚¨åœ¨targetä¸­çš„åŒ¿åå‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨dep.depend()å°†å…¶æ¨åˆ°å®ƒçš„è®¢é˜…è€…ï¼ˆç”¨æ¥å­˜å‚¨targetï¼‰æ•°ç»„ä¸­ã€‚
åŒç†ï¼Œå› ä¸ºdata.quantityè¢«è®¿é—®ï¼Œæˆ‘åŒæ ·å¸Œæœ›quantityå±æ€§çš„ä¾èµ–ç±»å°†è¿™ä¸ªå­˜å‚¨åœ¨targetä¸­çš„åŒ¿åå‡½æ•°æ¨å…¥å…¶è®¢é˜…è€…ï¼ˆç”¨æ¥å­˜å‚¨targetï¼‰æ•°ç»„ä¸­ã€‚

![2](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/2.jpg)

å¦‚æœæˆ‘æœ‰å¦ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œé‡Œè¾¹åªæ˜¯data.priceè¢«è®¿é—®ï¼Œæˆ‘å¸Œæœ›åªæ˜¯å°†å…¶æ¨é€åˆ°priceå±æ€§çš„ä¾èµ–ç±»ä¸­ã€‚

![3](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/3.jpg)

æˆ‘ä»¬éœ€è¦åœ¨priceæ›´æ–°çš„æ—¶å€™ï¼Œæ¥è°ƒç”¨dep.notify()ï¼Œæˆ‘ä»¬æƒ³è¦çš„ç»“æœå°±æ˜¯è¿™æ ·çš„ï¼š

```js
console.log(total) // >> 10
price = 20 // æ­¤æ—¶ï¼Œéœ€è¦è°ƒç”¨priceä¸Šçš„notify()
console.log(total) // >> 40
```

æˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•æ¥è¿æ¥dataé‡Œçš„å±æ€§ï¼ˆå¦‚priceæˆ–quantityï¼‰ï¼Œæ‰€ä»¥å½“å®ƒè¢«è®¿é—®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†targetä¿å­˜åˆ°æˆ‘ä»¬çš„è®¢é˜…è€…æ•°ç»„ä¸­ï¼Œå½“å®ƒè¢«æ”¹å˜æ—¶ï¼Œè¿è¡Œæˆ‘ä»¬å­˜å‚¨åœ¨è®¢é˜…è€…æ•°ç»„ä¸­çš„å‡½æ•°ã€‚

### âœ… è§£å†³æ–¹æ¡ˆ: Object.defineProperty()
æˆ‘ä»¬éœ€è¦äº†è§£ä¸‹ES5ä¸­çš„Object.defineProperty()å‡½æ•°ã€‚å®ƒå¯ä»¥ä¸ºå±æ€§å®šä¹‰getterå’Œsetterå‡½æ•°ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„åŸºæœ¬ç”¨æ³•ï¼š

```js
let data = { price: 5, quantity: 2 }

Object.defineProperty(data, 'price', {
  get() {
    console.log(`I was accessed`)
  },
  set(newVal) {
    console.log(`I was changed`);
  }
})
data.price // è°ƒç”¨get() >> I was accessed
data.price = 20 // è°ƒç”¨set() >> I was changed
```

å¦‚ä½ æ‰€è§ï¼Œæ§åˆ¶å°æœ‰ä¸¤è¡Œè¾“å‡ºï¼Œä½†æ˜¯ï¼Œå®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰getæˆ–setä»»ä½•å€¼ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç”¨æ³•å¹¶ä¸åˆç†ã€‚æˆ‘ä»¬ç°åœ¨å°†å…¶æ¢å¤ï¼Œget()æ–¹æ³•è¿”å›ä¸€ä¸ªå€¼ï¼Œset()æ–¹æ³•æ›´æ–°ä¸€ä¸ªå€¼ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå˜é‡internalValueæ¥å­˜å‚¨æˆ‘ä»¬å½“å‰çš„priceã€‚

```js
let data = { price: 5, quantity: 2 }

let internalValue = data.price // åˆå§‹çš„å€¼

Object.defineProperty(data, 'price', {
  get() {
    console.log(`Getting price: ${internalValue}`)
    return internalValue
  },
  set(newVal) {
    console.log(`Setting price to: ${newVal}`);
    internalValue = newVal
  }
})
total = data.price * data.quantity  // è°ƒç”¨get() >> Getting price: 5
data.price = 20 // è°ƒç”¨set()  >> Setting price to: 20
```

å½“æˆ‘ä»¬çš„getå’Œsetæ­£å¸¸å·¥ä½œæ—¶ï¼Œæ§åˆ¶å°è¾“å‡ºçš„ç»“æœä¹Ÿä¸ä¼šå‡ºç°å…¶ä»–å¯èƒ½ã€‚

æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è·å–å’Œè®¾ç½®å€¼æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„é€šçŸ¥ã€‚é€šè¿‡ä¸€äº›é€’å½’ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºdataå†…çš„æ‰€æœ‰å±æ€§è¿è¡ŒObject.definePropertyã€‚è¿™æ—¶å€™å°±å¯ä»¥ç”¨åˆ°Object.keys(data)ï¼Œåƒè¿™æ ·ï¼š

```js
let data = { price: 5, quantity: 2 }

Object.keys(data).forEach(key => {
  let internalValue = data[key]
  Object.defineProperty(data, key, {
    get() {
      console.log(`Getting ${key}: ${internalValue}`)
      return internalValue
    },
    set(newVal) {
      console.log(`Setting ${key} to: ${newVal}`);
      internalValue = newVal
    }
  })
})

total = data.price * data.quantity
data.price = 20
```

ç°åœ¨æ¯ä¸ªå±æ€§éƒ½æœ‰äº†getå’Œsetï¼Œæ§åˆ¶å°çš„è¾“å‡ºå¾ˆå¥½çš„è¯å®äº†è¿™ä¸€ç‚¹ã€‚

```
Getting price: 5
Getting quantity: 2
Setting price to: 20
```

### ğŸ›  ç»“åˆè¿™ä¸¤ä¸ªæƒ³æ³•

```js
total = data.price * data.quantity
```

å½“è¿™æ®µä»£ç è¿è¡Œå¹¶è·å–priceå€¼æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›priceè®°ä½è¿™ä¸ªåŒ¿åå‡½æ•°ï¼ˆtargetï¼‰ã€‚è¿™æ ·ï¼Œå¦‚æœpriceå‘ç”Ÿå˜åŒ–æˆ–è€…è¢«èµ‹æ–°å€¼æ—¶ï¼Œå®ƒå°±ä¼šé‡æ–°è§¦å‘è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºå®ƒçŸ¥é“è¿™ä¸€è¡Œä¾èµ–äºå®ƒã€‚ä½ å¯ä»¥è¿™æ ·ç†è§£ã€‚

Get =>è®°ä½è¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œå½“æˆ‘ä»¬çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬ä¼šå†æ¬¡è¿è¡Œå®ƒã€‚

Set =>è¿è¡Œä¿å­˜çš„åŒ¿åå‡½æ•°ï¼Œæˆ‘ä»¬çš„å€¼å‘ç”Ÿæ”¹å˜ã€‚

æˆ–è€…å°±æˆ‘ä»¬çš„Dep Classè€Œè¨€

è®¿é—®price (get) => è°ƒç”¨dep.depend()ä»¥ä¿å­˜å½“å‰target

ä¿®æ”¹price (set) => ç”¨priceè°ƒç”¨dep.notify(), é‡æ–°è¿è¡Œå…¨éƒ¨çš„targets

è®©æˆ‘ä»¬ç»“åˆè¿™ä¸¤ä¸ªæƒ³æ³•ï¼Œç„¶åçœ‹çœ‹æˆ‘ä»¬çš„æœ€ç»ˆä»£ç ï¼š

```js
let data = { price: 5, quantity: 2 }
let target = null

class Dep {
  constructor () {
    this.subscribers = []
  }
  depend () {
    if (target && !this.subscribers.includes(target)) {
      this.subscribers.push(target)
    }
  }
  notify () {
    this.subscribers.forEach(sub => sub())
  }
}

Object.keys(data).forEach(key => {
  let internalValue = data[key]

  const dep = new Dep()

  Object.defineProperty(data, key, {
    get() {
      dep.depend()
      return internalValue
    },
    set(newVal) {
      internalValue = newVal
      dep.notify()
    }
  })
})

function watcher(myFun) {
  target = myFun
  target()
  target = null
}

watcher(() => {
  data.total = data.price * data.quantity
})
```

ç°åœ¨æˆ‘ä»¬åœ¨æ§åˆ¶å°è¯•ä¸€è¯•ï¼š

![4](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/4.jpg)

æ­£æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„ï¼æ¯å½“priceæˆ–quantityæ›´æ–°æ—¶ï¼Œæˆ‘ä»¬çš„totaléƒ½ä¼šèµ‹å€¼ã€‚è¿™ä¸ªæ¥è‡ªVueæ–‡æ¡£çš„æ’å›¾çš„æ„ä¹‰å°±å¾ˆæ˜æ˜¾äº†ã€‚

![5](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/5.jpg)

ä½ çœ‹åˆ°é‚£ä¸ªå¸¦getterå’Œsetterçš„dataåœˆï¼ˆç´«è‰²ï¼‰äº†å—ï¼Ÿçœ‹èµ·æ¥åº”è¯¥å¾ˆçœ¼ç†Ÿï¼æ¯ä¸ªç»„ä»¶å®ä¾‹éƒ½æœ‰ä¸€ä¸ªwatcherå®ä¾‹ï¼ˆè“è‰²åœˆï¼‰ï¼Œå®ƒä»getterä¸­æ”¶é›†ï¼ˆçº¢çº¿ï¼‰ä¾èµ–é¡¹ã€‚ç¨åè°ƒç”¨setteræ—¶ï¼Œå®ƒä¼šé€šçŸ¥ç›‘è§†å™¨ï¼Œä»è€Œå®ç°é‡æ–°æ¸²æŸ“çš„åŠŸèƒ½ã€‚ä¸‹è¾¹æ˜¯æˆ‘ä¿®æ”¹åçš„æ’å›¾ï¼š

![6](http://boscdn.bpc.baidu.com/assets/easonyq/data-binding/6.jpg)

æ˜¾ç„¶ï¼ŒVueåœ¨å¹•ååšçš„æ›´ä¸ºå¤æ‚ï¼Œä½†ä½ ç°åœ¨å·²ç»å¯¹å…¶åŸç†æœ‰æ‰€äº†è§£äº†ã€‚

### âª æ€»ç»“

* å¦‚ä½•åˆ›å»ºä¸€ä¸ªDep classæ¥æ”¶é›†ä¾èµ–é¡¹ï¼ˆdependï¼‰å¹¶é‡æ–°è¿è¡Œæ‰€æœ‰ä¾èµ–é¡¹ï¼ˆnotifyï¼‰ã€‚
* å¦‚ä½•åˆ›å»ºä¸€ä¸ªwatcheræ¥ç›‘å¬æˆ‘ä»¬æ­£åœ¨è¿è¡Œçš„ä»£ç ï¼Œå¯èƒ½éœ€è¦ä¿å­˜è¿™äº›ä»£ç ï¼ˆtargetï¼‰å¹¶æ·»åŠ ä¸ºä¾èµ–é¡¹ã€‚
* æ€æ ·ä½¿ç”¨Object.defineProperty()åˆ›å»ºgetterå’Œsetterã€‚

## æºç åˆ†æéƒ¨åˆ†ï¼ˆæ—§ï¼‰

ä»¥ä¸‹å†…å®¹æ˜¯æˆ‘é˜…è¯» Vue æºç å¹¶å‚è€ƒ DDFE Blog [Vue 1.0 çš„æ•°æ®ç»‘å®š](https://github.com/DDFE/DDFE-blog/issues/7) ç†è§£çš„å†…å®¹ï¼Œæ˜¯æœ€æ—©çš„ç†è§£ã€‚è™½ç„¶æ­£ç¡®ï¼Œä½†ä¸å¦‚ä¸Šé¢å¾ªåºæ¸è¿›çš„ä¾‹å­æ¥çš„ç›´è§‚ã€‚

æ•°æ®ç»‘å®šçš„æ ¸å¿ƒæ˜¯ä½¿ç”¨ `Object.defineProperty()`(Vue 3.x å¼€å§‹ä½¿ç”¨ `Proxy`)ã€‚ç®€å•ä»‹ç»è¿™ä¸ªæ–¹æ³•ï¼š

```javascript
let someObj = {};
Object.defineProperty(someObj, 'key', {
    value: 'value',
    writable: false,
    configurable: false,
    enumerable: false,
    get() {
        // do something
    },
    set(value) {
        // do something
    }
});

// å¯ä»¥é€šè¿‡æ–¹æ³•æ¥è¿”å›è¿™äº›é…ç½®é¡¹
let result = Object.getOwnPropertyDescriptor(someObj, 'key');
```

é€šè¿‡è®¾ç½® set/get æ–¹æ³•æ¥å®ç°å¯¹ HTML çš„åŒæ­¥æ“ä½œï¼Œå³å¯åšåˆ°ç®€å•çš„æ•°æ®å’Œ DOM èŠ‚ç‚¹çš„åŒå‘ç»‘å®šã€‚

### Vue ä¸­çš„æ•°æ®ç»‘å®š

[ç¤ºä¾‹ä»£ç ](https://github.com/liutao/vue2.0-source/blob/master/%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A.md)

Vue ä¸­çš„åŒå‘æ•°æ®ç»‘å®šï¼Œç®€å•ç‚¹æ¥è¯´åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š

1. Observerã€‚è¿™é‡Œçš„ä¸»è¦å·¥ä½œæ˜¯é€’å½’åœ°ç›‘å¬å¯¹è±¡ä¸Šçš„æ‰€æœ‰å±æ€§ï¼Œç»™å®ƒä»¬æ·»åŠ  setter/getterã€‚åœ¨å±æ€§å€¼æ”¹å˜çš„æ—¶å€™ï¼Œè§¦å‘ç›¸åº”çš„ watcherã€‚

2. Watcherã€‚è§‚å¯Ÿè€…ï¼Œå½“ç›‘å¬çš„æ•°æ®å€¼ä¿®æ”¹æ—¶ï¼Œæ‰§è¡Œå“åº”çš„å›è°ƒå‡½æ•°ï¼ˆVueé‡Œé¢çš„æ›´æ–°æ¨¡æ¿å†…å®¹ï¼‰ã€‚

3. Depã€‚è¿æ¥ Observer å’Œ Watcher çš„æ¡¥æ¢ï¼Œæ¯ä¸€ä¸ª Observer å¯¹åº”ä¸€ä¸ª Depï¼Œå®ƒå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜ä¸è¯¥ Observer ç›¸å…³çš„ Watcherã€‚

å†…éƒ¨è¿è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. é€šè¿‡ observer ç»™æ•°æ®å¯¹è±¡æ³¨å†Œ `getter/setter`ã€‚

2. new Watcher å¹¶æ³¨å†Œå›è°ƒå‡½æ•° `fn`ã€‚åœ¨ watcher çš„æ„é€ å‡½æ•°ä¸­ä¼šç›´æ¥è°ƒç”¨ `update()`ï¼Œå°±ä¼šç›´æ¥è¿è¡Œ `fn`ï¼Œäºæ˜¯æ¶‰åŠåˆ°æ•°æ®å¯¹è±¡çš„è¯»å–ï¼Œè°ƒç”¨äº† `getter`ï¼Œå°† watcher æ·»åŠ åˆ° dep çš„æ•°ç»„ `subs` ä¸­ã€‚

2. ä¿®æ”¹æ•°æ®æ—¶ï¼Œé€šè¿‡ observer æ³¨å†Œçš„ setterï¼Œè°ƒç”¨ `dep.notify()`

3. `dep.notify()` å†…éƒ¨è°ƒç”¨ `subs` æ•°ç»„ä¸­æ¯ä¸€ä¸ª watcher çš„ `update()`

4. watcher çš„ `update()` å†…éƒ¨è°ƒç”¨æ³¨å†Œæ˜¯çš„å›è°ƒå‡½æ•° `fn` ï¼ˆVue æ›´æ–°æ¨¡æ¿å†…å®¹ï¼‰ï¼Œå› æ­¤å®ç°äº†æ›´æ–° DOMã€‚

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

* Observer

    ```javascript
    function Observer(obj, key, value) {
        var dep = new Dep();
        // å…ˆå¿½ç•¥æ•°ç»„ï¼Œå› ä¸ºæ•°ç»„æ¯”è¾ƒå¤æ‚

        if (Object.prototype.toString.call(value) == '[object Object]') {
            Object.keys(value).forEach(function(key){
                new Observer(value,key,value[key])
            })
        };

        Object.defineProperty(obj, key, {
            enumerable: true,
            configurable: true,
            get: function() {
                if (Dep.target) {
                    dep.addSub(Dep.target);
                };
                return value;
            },
            set: function(newVal){
                value = newVal;
                dep.notify();
            }
        })
    }
    ```

* Watcher

    ```javascript
    function Watcher(fn){
        this.update = function() {
            Dep.target = this;
            fn();
            Dep.target = null;
        }
        this.update();
    }
    ```

* Dep

    ```javascript
    function Dep(){
        this.subs = [];

        this.addSub = function (watcher) {
            this.subs.push(watcher);
        }

        this.notify = function(){
            this.subs.forEach(function(watcher){
                watcher.update();
            });
        }
    }
    ```

* ä½¿ç”¨æ–¹å¼

    ```html
    <div id="test"></div>
    <script type="text/javascript">
        var obj = {
            a: 1,
            b: 2,
            c: 3
        }
        Object.keys(obj).forEach(function(key){
            new Observer(obj, key, obj[key])
        });
        new Watcher(function(){
            document.querySelector("#test").innerHTML = obj.a;
        })
    </script>
    ```

__ç‰¹åˆ«æ³¨æ„ï¼š__ ä¾‹å­åªæ˜¯ç®€å•ç¤ºä¾‹ï¼Œæœ¬èº«è¿˜å­˜åœ¨é—®é¢˜ã€‚ä¾‹å¦‚æ¯æ¬¡ getter éƒ½è°ƒç”¨ `addSub` å°±ä¼šå¯¼è‡´ç›¸åŒçš„ watcher è¢«é‡å¤æ·»åŠ ï¼Œç»‘å®šåœ¨å˜é‡ä¸Šçš„ watcher ä¼šè¶Šæ¥è¶Šå¤šï¼Œä¹Ÿä¼šé‡å¤è§¦å‘ `update`ã€‚å› æ­¤ Vue ä¸­å¹¶ä¸ç›´æ¥è°ƒç”¨ `addSub`ï¼Œè€Œæ˜¯ç”¨ `depend` æ–¹æ³•æ¥å±è”½è¿™ä¸ªé—®é¢˜ã€‚

Vue ä¸­çš„æƒ…å†µï¼Œå›åˆ°å‡½æ•° `fn` åŒ…å«çš„æ˜¯ç”Ÿæˆ `render` å‡½æ•°ï¼Œç”Ÿæˆ `vdom`ï¼Œå†æ›´æ–°åˆ°é¡µé¢ä¸Šï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œ `innerHTML`ã€‚å…¶ä»–çš„ wather, observer å’Œ dep éƒ½æ˜¯ç±»ä¼¼çš„ã€‚

![Vue](https://camo.githubusercontent.com/3845b9554e62650727fa7cae8f1c169060b879f7/68747470733a2f2f636e2e7675656a732e6f72672f696d616765732f646174612e706e67)

### Observer

åœ¨ `src/core/instance/state.js` ä¸­çš„ `initState` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº† `observe` æ–¹æ³•æ¥ç›‘å¬æ¯ä¸ª `vm` å¯¹è±¡ã€‚ä¸‹é¢æ˜¯ `observe` æ–¹æ³•çš„å®ç°ã€‚

`src/core/observer/index.js`

æ„é€ å‡½æ•°ä¸­åšäº†è¿™äº›äº‹æƒ…ï¼š

1. å‡†å¤‡å·¥ä½œã€‚åŒ…æ‹¬ `new Dep()`, æ·»åŠ  `__ob__` æ¥å­˜æ”¾ observerï¼ˆ`def(value, '__ob__', this)`ï¼‰ã€‚

2. å¦‚æœæ˜¯æ•°ç»„ï¼Œéå†åé€ä¸ªè°ƒç”¨ `observe()`ã€‚

3. å¦‚æœæ˜¯å¯¹è±¡ï¼Œé€šè¿‡ `Object.keys()` éå†ï¼Œåˆ†åˆ«è°ƒç”¨ `defineReactive(obj, key, value)`

æ¥ç€æ˜¯ `defineReactive(obj, key, val)` æ–¹æ³•ã€‚

1. ä¿å­˜ `obj.key` åŸå§‹çš„ `setter/getter`

2. ä½¿ç”¨ `Object.defineProperty` é‡æ–°å®šä¹‰ `obj.key`ã€‚

    1. æ–°çš„ getter ä¸­ï¼Œå…ˆè®°å½•è¦è¿”å›çš„å€¼ã€‚è¿™é‡Œåˆ¤æ–­æ˜¯å¦æœ‰åŸå§‹çš„ getterã€‚å¦‚æœæœ‰å°±è°ƒç”¨åŸå§‹çš„ getterï¼Œå¦åˆ™å°±ç­‰äº `val`ã€‚

    2. è°ƒç”¨ `dep.depend()` æ¥æ·»åŠ ä¾èµ–å…³ç³»ã€‚ç±»ä¼¼äºä¸Šé¢ä¾‹å­ä¸­çš„ `dep.addSub()`ï¼Œä½†å¢åŠ äº†å»é‡åŠŸèƒ½ã€‚

    3. setter å’Œä¸Šé¢ä¾‹å­ç›¸åŒã€‚å¦‚æœè®¾ç½®çš„å€¼å’ŒåŸæ¥ä¸åŒï¼Œåˆ™è°ƒç”¨ `dep.notify()`ã€‚åŸå§‹ setter çš„è°ƒç”¨ä¹Ÿå’Œ getter ä¸€æ ·ã€‚

    4. è°ƒç”¨ `observe` æ–¹æ³•è®°å½•è¿”å›çš„ `childOb`ï¼Œåœ¨ getter æ—¶è°ƒç”¨ `childOb.dep.depend()`

æœ€åæ˜¯ `observe(value)` æ–¹æ³•ï¼Œå®ƒè¿”å› Obeserver å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰åˆ™åˆ›å»º (new) ä¸€ä¸ªã€‚

æ•°ç»„çš„æƒ…å†µç•¥å¾®å¤æ‚ï¼Œå› ä¸º `push`, `unshift` `sort` ç­‰æ–¹æ³•æ˜¯ä½œç”¨åœ¨æ•°ç»„æœ¬èº«è€Œä¸æ˜¯å…¶ä¸­çš„å…ƒç´ ä¸Šï¼Œå› æ­¤ Vue é‡å†™äº†è¿™äº›æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨è°ƒç”¨çš„æ—¶å€™æ’å…¥ä¸€äº›äº‹æƒ…ã€‚

è§‚å¯Ÿ `/src/core/oberver/array.js`ï¼Œ å…¶ä¸­å¯¹å¯èƒ½æ”¹å˜æ•°ç»„çš„æ“ä½œ(push, pop, shift, unshift, splice, sort, reverse)éƒ½åšäº†é‡æ–°å®šä¹‰ï¼Œå¯¼å‡ºæˆ arrayMethods ï¼ˆä»ç©ºçš„æ•°ç»„ prototype å¼€å§‹åˆ›å»ºå¹¶æ·»åŠ é‡å†™åçš„æ–¹æ³•ï¼‰å’Œ arrayKeysï¼ˆé‡å†™åæ–¹æ³•çš„åå­—åˆ—è¡¨ï¼‰ã€‚

å½“å‘ç° push, unshift, splice ä¸‰ä¸ªæ–¹æ³•æ—¶ï¼Œæ¶‰åŠåˆ°æ•°ç»„å…ƒç´ å¢åŠ çš„ï¼Œå°±éœ€è¦å¯¹æ•°ç»„éå†ï¼Œå†æ¯ä¸ªæ·»åŠ  Observer æ¥ç›‘å¬ä»–ä»¬ã€‚ï¼ˆå› æ­¤ observe æ–¹æ³•ä¼šåˆ¤æ–­ .__ob__ æœ‰æ²¡æœ‰ï¼Œæœ‰å°±ä¸é‡å¤æ·»åŠ äº†ï¼‰

### Dep

å’Œä¸Šè¿°ä¾‹å­ä¸­å¤§è‡´ç›¸åŒï¼Œè®°å½• `this.id` å’Œ `this.subs`ï¼ˆæ•°ç»„ï¼‰ ä¸¤ä¸ªå±æ€§ã€‚

`id` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œæ˜¯ä¸ªè‡ªå¢çš„æ•°å­—ï¼Œä»0å¼€å§‹ã€‚

`subs` è®°å½•ä¾èµ–çš„ watcherã€‚

ç›¸å…³æ–¹æ³•æœ‰ï¼š

* `addSub` æ·»åŠ åˆ°ä¾èµ–æ•°ç»„
* `removeSub` ä»æ•°ç»„ä¸­å»é™¤ä¾èµ–
* `depend` è°ƒç”¨ Watcher çš„ `addDep` æ–¹æ³•ï¼ˆå…¶å®ä¹Ÿæ˜¯æ·»åŠ ä¾èµ–ï¼Œä½†ä¸æ˜¯å•çº¯çš„ `addSub`ï¼Œå¤šä¸€æ­¥å»é‡ï¼‰
* `notify` é€ä¸ªè°ƒç”¨ watcher çš„ `update` æ–¹æ³•

### Watcher

#### mount

åœ¨ Vue æŒ‚è½½æ—¶ï¼Œæ˜¯é€šè¿‡å¦‚ä¸‹ä»£ç è¿›è¡Œçš„

```javascript
vm._watcher = new Watcher(vm, updateComponent, noop)
```

å¯¹åº” watcher çš„æ„é€ å‡½æ•°ï¼Œ`expOrFn` å°±æ˜¯ `updateComponent`ï¼Œ `cb` ç­‰äº `noop`ã€‚

åœ¨ watcher å†…éƒ¨çš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨äº† `this.value = this.get()`ã€‚åœ¨ `get` æ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº† `value = this.getter.call(vm, vm)`ã€‚è¿™é‡Œ `this.getter` åœ¨æ„é€ å‡½æ•°ä¸­è¢«å®šä¹‰ä¸º `expOrFn`ï¼Œä¹Ÿå³ `updateComponent`ã€‚æ‰€ä»¥æœ€ç»ˆ:

```javascript
value = updateComponent.call(vm, vm)
```

`updateComponent` å†…éƒ¨å®é™…ä¸Šæ˜¯ `vm._update(vm._render(), hydrating)`ï¼Œå› æ­¤æ¸²æŸ“æ¨¡æ¿æ—¶ä¼šè¯»å– data ä¹Ÿå°±è°ƒç”¨äº† data çš„ getterï¼Œé€šè¿‡ dep å»ºç«‹äº†ç»‘å®šå…³ç³»ã€‚

å½“æ•°æ®å˜åŒ–æ—¶ï¼Œç”± dep è°ƒç”¨ watcher çš„ `update` è¿›è€Œè°ƒç”¨ `run`ã€‚`run` ä¸­åˆæœ‰ `this.value = this.get()`ï¼Œå› æ­¤å°±åˆæ‰§è¡Œäº†ä¸€é `updateComponent`ã€‚

get æ–¹æ³•ä¸­è°ƒç”¨çš„ `pushTarget(this)` ç›¸å½“äºä¾‹å­ä¸­çš„ `Dep.target = this`ï¼Œåªä¸è¿‡è¿™é‡Œä¼šè®°å½•å¤šä¸ª (`targetStack`)ï¼Œè€Œä¸æ˜¯åªæœ‰ä¸€ä¸ªã€‚æœ€åè°ƒç”¨çš„ `popTarget()` ä¹Ÿæ˜¯åŒç†ã€‚

#### computed

åœ¨ `computed` æƒ…å†µä¸‹ï¼Œä½¿ç”¨çš„æ˜¯ `new Watcher(vm, getter, noop)`ã€‚è¿™ä¸ª `getter` å°±æ˜¯ç”¨æˆ·å®šä¹‰çš„è®¡ç®—å±æ€§çš„è®¡ç®—æ–¹æ³•ï¼Œæ˜¯ä¸ªå‡½æ•°ã€‚æ‰€ä»¥å’ŒæŒ‚è½½æƒ…å†µç±»ä¼¼ï¼Œæœ€ç»ˆ `getter` åœ¨æ„é€ å‡½æ•°æ—¶è¢«è°ƒç”¨äº†ä¸€æ¬¡ç”¨ä»¥è®¡ç®—åˆå§‹çŠ¶æ€çš„å€¼ï¼Œåç»­åœ¨æ›´æ–°æ—¶å› ä¸º `update` çš„å½±å“ï¼Œä¹ŸåŒæ ·ä¼šå†ç”± `getter` è®¡ç®—ä¸€æ¬¡ã€‚

#### $watch

$watch æ›´åŠ ç›´ç™½ï¼Œæœ¬èº«å°±ç›´æ¥æŠŠ `expOrFn` å½“åšå‚æ•°ï¼Œå› æ­¤å’Œä¸Šé¢ä¸¤ç§æƒ…å†µä¸€æ ·ã€‚

#### å»¶è¿Ÿæ›´æ–°

å½“è°ƒç”¨ `update` æ—¶ï¼Œä¸€èˆ¬æ€è·¯å°±ç›´æ¥æ‰§è¡Œ `run`ï¼Œå°±ç›´æ¥æ‰§è¡Œ `expOrFn` äº†ã€‚ä½† Vue åœ¨è¿™é‡Œè¿˜è¿›è¡Œäº†ä¸€ä¸ªä¼˜åŒ–ï¼šä¸ç›´æ¥æ‰§è¡Œ `run`ï¼Œè€Œæ˜¯å°† watcher å­˜æ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç­‰å¾… `nextTick` å†æ¸…ç©ºæ•°ç»„ï¼Œé€ä¸ªæ‰§è¡Œ `run`ã€‚

æ¯”å¦‚è¯´æŸä¸ªå˜é‡åœ¨ä¸€ä¸ª tick ä¸­å˜åŒ–äº†3æ¬¡ã€‚å¦‚æœç›´æ¥æ‰§è¡Œ `run`ï¼Œé‚£ä¹ˆéœ€è¦é‡æ–°è®¡ç®— 3 æ¬¡ï¼Œæ›´æ–° 3 æ¬¡DOMï¼›è€Œé‡‡ç”¨å»¶è¿Ÿæ›´æ–°çš„è¯ï¼Œå› ä¸ºæ˜¯åŒä¸€ä¸ª watcher é‚£ä¹ˆåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ `run`ï¼Œé‚£ä¹Ÿå°±åªè®¡ç®—å’Œæ›´æ–° 1 æ¬¡äº†ã€‚1 ä¸ª tick å‘ç”Ÿå¤šæ¬¡å˜åŒ–ä¹Ÿå¹¶ä¸å°‘è§ï¼Œä¾‹å¦‚åœ¨åŒæ­¥ä»£ç ä¸­ä¸€ä¸ªå˜é‡çš„å€¼è¢«åå¤ä¿®æ”¹ã€‚

### æ€»ç»“

åœ¨ Vue çš„æ„é€ å‡½æ•°ä¸­ï¼Œåœ¨ `initState` æ­¥éª¤ä¸­ä¼šé€å±‚è°ƒç”¨ `observe(value)` ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰æ•°æ®ç»‘å®šçš„å…¥å£ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. å¦‚æœ `value` ä¸æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œåˆ™ç»“æŸã€‚ï¼ˆè¡¨ç¤ºæ˜¯åŸºæœ¬ç±»å‹ï¼Œä¸ç”¨ç›‘å¬ï¼‰
2. å¦‚æœæœ‰ `value.__ob__`ï¼Œç›´æ¥è¿”å›ã€‚ï¼ˆè¡¨ç¤ºä¹‹å‰å·²ç»è®¾å®šè¿‡ç›‘å¬å™¨äº†ï¼‰
3. `new Observer(value)`
4. `this.dep = new Dep()`ã€‚æ­¤å¤–å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™éå†å¹¶è°ƒç”¨ `observe` å›åˆ°æœ€å¼€å¤´ï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™éå†å¹¶è°ƒç”¨ `defineReactive(obj, key, val)`
5. å¯¹ val è¿›è¡Œä¸‹ä¸€ä¸ªå±‚çº§çš„é€’å½’ï¼Œå³ `childObj = observe(val)` ï¼ˆè¡¨ç¤ºå¦‚æœ val ä¾ç„¶æ˜¯ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆé€’å½’è°ƒç”¨ï¼›å¦‚æœ val æ˜¯ä¸ªåŸºæœ¬ç±»å‹ï¼Œé‚£å°±ç»“æŸï¼‰ã€‚
6. é‡æ–°å®šä¹‰ `obj.key` çš„ getter/setterã€‚åœ¨ getter ä¸­ï¼Œé€šè¿‡ `dep.depend()` æŠŠ __å½“å‰ Watcher__ æ·»åŠ åˆ°æ•°ç»„å½¢æˆä¾èµ–å…³ç³»ã€‚åœ¨ setter ä¸­ï¼Œé€šè¿‡ `dep.notify()` é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨ã€‚ï¼ˆåœ¨ setter ä¸­ï¼Œå› ä¸ºå€¼å˜åŒ–äº†ï¼Œæ‰€ä»¥ä¹Ÿå¿…é¡»è¿›è¡Œ `observe(newVal)`ï¼‰
7. `dep.depend()` ä¼šå¾€ `Dep` ç±»çš„ `subs` æ•°ç»„æ·»åŠ  __å½“å‰__ çš„ watcher ï¼ˆå­˜æ”¾äº `Dep.target`ï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª watcherï¼‰ã€‚æ·»åŠ ä¹‹å‰ä¼šåˆ¤æ–­ watcher id è¿›è¡Œå»é‡ã€‚

ä»¥ä¸Šä»…ä»…å¯¹æ‰€æœ‰ data è¿›è¡Œäº†è§‚æµ‹ã€‚åœ¨ç”¨æˆ·è°ƒç”¨ `$mount` æˆ–è€… `computed` æˆ–è€… `watch` æ—¶ï¼ŒVue ä¼šè¿›è¡Œç¬¬äºŒä¸ªæ­¥éª¤ï¼šè®¢é˜…è¿™ä¸ªè§‚æµ‹çš„ç»“æœï¼Œå³ `new Watcher(vm, updateComponent/getter, noop)`ã€‚

8. watcher çš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šé¦–å…ˆæ‰§è¡Œä¸€ééœ€è¦ç›‘å¬çš„å†…å®¹ (`expOrFn`ï¼Œç¬¬äºŒä¸ªå‚æ•°)ã€‚åœ¨æ‰§è¡Œä¹‹å‰ `pushTarget(this)`ï¼Œä»¤ `Dep.target` æŒ‡å‘è‡ªå·±ï¼ˆå½“å‰ watcherï¼‰ã€‚æ‰§è¡Œ `expOrFn` æ—¶ï¼Œå› ä¸ºå®ƒä¾èµ–çš„æ‰€æœ‰ data çš„ getter ä¸­ `Dep.target` æœ‰å€¼ï¼Œå› æ­¤é€šè¿‡ `dep.depend()` æˆåŠŸæ·»åŠ äº†å½“å‰ watcher ä¸ºä¾èµ–ã€‚__å…¶ä»–æ²¡æœ‰ watcher ä½†ç”¨åˆ°è¿™äº› data çš„ä¼šå› ä¸º `Dep.target === undefined` è€Œä¸ä¼šæ·»åŠ ä¾èµ–ï¼›å½“å‰ watcher æ²¡æœ‰ä½¿ç”¨åˆ°çš„å˜é‡ä¹Ÿä¼šå› ä¸ºæ²¡æœ‰è°ƒç”¨ä»–ä»¬çš„ getter è€Œæ²¡æœ‰æ·»åŠ ä¾èµ–ã€‚__

ç¬¬ä¸‰æ­¥ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶

9. ç”± setter è§¦å‘ `dep.notify()` ä¾æ¬¡å–å‡º `subs` ä¸­æ‰€æœ‰æ³¨å†Œçš„ watcherï¼Œå¹¶é€ä¸ªè°ƒç”¨å®ƒçš„ `update()`ã€‚è¿™æ˜¯å…¸å‹çš„è§‚å¯Ÿè€…æ¨¡å¼ã€‚
10. `update()` æŸäº›æƒ…å†µä¼šç›´æ¥æ‰§è¡Œ `run` ï¼Œè¿›è€Œæ‰§è¡Œå½“æ—¶æ³¨å†Œ `Watcher` æ—¶çš„ `expOrFn` é‡æ–°æ¸²æŸ“é¡µé¢/è®¡ç®—ç»“æœã€‚æ›´å¤šæƒ…å†µä¼šè¿›è¡Œå»¶è¿Ÿæ‰§è¡Œï¼Œå³æŠŠå½“å‰ watcher æ·»åŠ åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚åœ¨ `nextTick` å–å‡ºé˜Ÿåˆ—çš„æ‰€æœ‰å…ƒç´ æ‰§è¡Œ `run`ï¼Œè¿™æ ·é¿å…å¤šæ¬¡æ‰§è¡Œæ¶ˆè€—æ€§èƒ½ã€‚
